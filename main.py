import os
import tempfile
from telegram import Bot, Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, MessageHandler, filters, CallbackQueryHandler, ContextTypes
from gtts import gTTS

# ----------------------------------------
# ๐ฏ ุชูุธู ุชูฺฉู ุชูฺฏุฑุงู
# ----------------------------------------
TOKEN = os.environ.get("TELEGRAM_TOKEN")
if not TOKEN:
    print("โ๏ธ ูุชุบุฑ ูุญุท TELEGRAM_TOKEN ูพุฏุง ูุดุฏ! ุงุฒ ุชูฺฉู ูููุช ุงุณุชูุงุฏู ูโุดูุฏ.")
    TOKEN = "8249435097:AAGOIS7GfwBayCTSZGFahbMhYcZDFxzSGAg"

bot = Bot(token=TOKEN)

# ----------------------------------------
# โ๏ธ ุญุฐู ูุจููฺฉ ูุจู ูุจู ุงุฒ ุณุช ฺฉุฑุฏู ุฌุฏุฏ
# ----------------------------------------
import asyncio
async def reset_webhook():
    try:
        await bot.delete_webhook()
        print("๐งน Webhook ูุจู ุจุง ููููุช ูพุงฺฉ ุดุฏ.")
    except Exception as e:
        print(f"โ๏ธ ุฎุทุง ุฏุฑ ุญุฐู ูุจููฺฉ ูุจู: {e}")

asyncio.run(reset_webhook())

# ----------------------------------------
# ูพุงู ุฎูุดโุขูุฏ ู ูุนุฑู ุฑุณู
# ----------------------------------------
INTRO_TEXT = (
    "๐ ุณูุงู! ูู ุฏุณุชุงุฑ ุญููู ูุญุถุฑุจุงุด ูุณุชู.\n"
    "ุงู ุฑุจุงุช ุชูุณุท ูุณุชุฑู ุจูโุทุจุง ุณุงุฎุชู ุดุฏู ุงุณุช โ๏ธ\n"
    "ูู ูพุงุณุฎฺฏู ุณุคุงูุงุช ุญููู ุดูุง ูุณุชู โ ูู ูุชู ู ูู ุตูุช ๐ง\n"
    "ฺฉุงูู ุณุคุงู ุญูููโุงุช ุฑู ุจูุฑุณุช ุชุง ุฑุงูููุงุช ฺฉูู."
)

# ----------------------------------------
# ุชุงุจุน ุชููุฏ ูพุงุณุฎโูุง ุญููู
# ----------------------------------------
def legal_answer(text):
    text = text.strip().lower()

    if any(word in text for word in ["ุงุฒุฏูุงุฌ", "ูฺฉุงุญ"]):
        return (
            "๐ ุงุฒุฏูุงุฌ ฺฉ ุงุฒ ุนููุฏ ููู ุฏุฑ ูุงููู ูุฏู ุงุฑุงู ุงุณุช. "
            "ุจุฑุง ุตุญุช ุงุฒุฏูุงุฌุ ุฑุถุงุช ฺฉุงูู ุฒู ู ูุฑุฏุ ุงููุช ู ุดุงูุฏุงู ูุงุฒู ุงุณุช. "
            "ุฏุฑ ูฺฉุงุญ ุฏุงุฆู ุซุจุช ุนูุฏ ุงูุฒุงู ุงุณุช ู ููุฑู ุงุฒ ุญููู ุฒู ูุญุณูุจ ูโุดูุฏ. "
            "ุฏุฑ ููุงุฑุฏ ุฎุงุต ูุงููุฏ ุงุฒุฏูุงุฌ ุจุง ุงุชุจุงุน ุฎุงุฑุฌุ ูุงุฒ ุจู ุงุฌุงุฒู ุฑุณู ูุฌูุฏ ุฏุงุฑุฏ."
        )
    elif "ููุฑู" in text:
        return (
            "๐ฐ ููุฑู ูุงู ุงุณุช ฺฉู ุฏุฑ ุฒูุงู ุนูุฏ ุจูโุนููุงู ุญู ุฒู ุชุนู ูโุดูุฏ. "
            "ุฒู ูุงูฺฉ ุขู ุงุณุช ู ูุฑ ุฒูุงู ูโุชูุงูุฏ ุขู ุฑุง ูุทุงูุจู ฺฉูุฏ. "
            "ุฏุฑ ุตูุฑุช ุงูุชูุงุน ุดููุฑุ ุฒู ูโุชูุงูุฏ ุงุฒ ุฏุงุฏฺฏุงู ุฏุฑุฎูุงุณุช ุตุฏูุฑ ุงุฌุฑุงู ฺฉูุฏ. "
            "ุฏุฑ ููุฑู ุนูุฏุงูุงุณุชุทุงุนูุ ุจุงุฏ ุชูุงู ูุงู ุดููุฑ ุซุงุจุช ุดูุฏ."
        )
    elif "ุทูุงู" in text:
        return (
            "๐ ุทูุงู ุจู ุฏู ููุน ุชูุงูู ู ุบุฑุชูุงูู ุชูุณู ูโุดูุฏ. "
            "ุฏุฑ ุทูุงู ุชูุงููุ ุฒูุฌู ุจุง ุฑุถุงุช ุฌุฏุง ูโุดููุฏ. "
            "ุฏุฑ ุบุฑุชูุงููุ ฺฉ ุงุฒ ุทุฑูู ุจุงุฏ ุฏูุงู ููุฌู ุงุฑุงุฆู ุฏูุฏ ูุซู ุนุณุฑ ู ุญุฑุฌ. "
            "ุซุจุช ุฑุณู ุทูุงู ู ุชุณูู ุญููู ูุงู ุฒู ุงูุฒุงู ุงุณุช."
        )
    elif "ูููู" in text:
        return (
            "๐ ูููู ุนู ุชุฃูู ูุงุฒูุง ุฒู ูุงููุฏ ุฎูุฑุงฺฉุ ูพูุดุงฺฉ ู ูุณฺฉู ุชูุณุท ุดููุฑ. "
            "ุนุฏู ูพุฑุฏุงุฎุช ูููู ุฌุฑู ุงุณุช ู ุฒู ูโุชูุงูุฏ ุดฺฉุงุช ฺฉูุฏ. "
            "ุฏุฑ ุนูุฏ ุฏุงุฆู ูููู ููุดู ุจุฑ ุนูุฏู ุดููุฑ ุงุณุช."
        )
    elif "ูุฑุงุฑุฏุงุฏ" in text or "ุนูุฏ" in text:
        return (
            "๐ ูุฑ ูุฑุงุฑุฏุงุฏ ูุนุชุจุฑ ุจุงุฏ ุณู ุดุฑุท ุฏุงุดุชู ุจุงุดุฏ: ูุตุฏ ู ุฑุถุงุ ุงููุช ู ููุถูุน ูุดุฑูุน. "
            "ุฏุฑ ุบุฑ ุงู ุตูุฑุช ุจุงุทู ุงุณุช. "
            "ุชูุตู ูโุดูุฏ ูุฑุงุฑุฏุงุฏูุง ููู ุฏุฑ ุฏูุชุฑุฎุงูู ุฑุณู ุชูุธู ุดูุฏ."
        )
    elif "ุงุฑุซ" in text or "ูุฑุงุซ" in text:
        return (
            "โฐ๏ธ ุงุฑุซ ุงููุงู ุงุณุช ฺฉู ูพุณ ุงุฒ ููุช ุดุฎุต ุจู ูุฑุงุซ ุชูุณู ูโุดูุฏ. "
            "ุณูู ูุฑ ูุงุฑุซ ุทุจู ูุงููู ูุดุฎุต ุงุณุช. "
            "ุจุฑุง ุชูุณู ุงุฑุซุ ฺฏูุงู ุงูุญุตุงุฑ ูุฑุงุซุช ุถุฑูุฑ ุงุณุช."
        )
    elif "ุดฺฉุงุช" in text or "ุฏุงุฏฺฏุงู" in text or "ฺฉูุฑ" in text:
        return (
            "โ๏ธ ุจุฑุง ุดฺฉุงุช ุจุงุฏ ููุน ุฏุนูุง ูุดุฎุต ุดูุฏ. "
            "ุดฺฉุงุช ฺฉูุฑ ุฏุฑ ุฏุงุฏุณุฑุง ู ุฏุนุงู ุญููู ุฏุฑ ุฏูุงุชุฑ ุฎุฏูุงุช ูุถุง ุซุจุช ูโุดูุฏ. "
            "ุฏุงุดุชู ูุฏุงุฑฺฉ ู ฺฉุงุฑุช ูู ุถุฑูุฑ ุงุณุช. "
            "ุฑุณุฏฺฏ ููฺฉู ุงุณุช ฺูุฏ ูุฑุญูู ุฏุงุดุชู ุจุงุดุฏ."
        )
    else:
        return (
            "๐ ุงู ููุถูุน ุชุฎุตุตโุชุฑ ุงุณุช ู ูุงุฒ ุจู ุจุฑุฑุณ ุฏูู ุฏุงุฑุฏ. "
            "ูพุดููุงุฏ ูโฺฉูู ุจุฑุง ูพุงุณุฎ ฺฉุงููโุชุฑ ุจู ุณุงุช ูุญุถุฑุจุงุด ูุฑุงุฌุนู ฺฉูุฏ:\n"
            "๐ www.mahzarbashi.ir"
        )

# ----------------------------------------
# ูพุงุณุฎ ุจู ูพุงูโูุง
# ----------------------------------------
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_text = update.message.text.strip()
    answer_text = legal_answer(user_text)
    reply_text = f"{answer_text}\n\n๐ ุจุฑุง ุดูุฏู ูพุงุณุฎุ ุฑู ุฏฺฉูู ุฒุฑ ุจุฒูุฏ:"
    keyboard = [[InlineKeyboardButton("๐ง ฺฏูุด ุฏุงุฏู ุตูุช", callback_data=f"voice:{answer_text}")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(reply_text, reply_markup=reply_markup)

# ----------------------------------------
# ูพุงุณุฎ ุตูุช
# ----------------------------------------
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data.startswith("voice:"):
        text = query.data.replace("voice:", "")
        tts = gTTS(text=text, lang='fa')
        with tempfile.NamedTemporaryFile(delete=False, suffix=".mp3") as tmp:
            tts.save(tmp.name)
            await bot.send_audio(chat_id=query.message.chat_id, audio=open(tmp.name, 'rb'))
        await query.edit_message_text("โ ูพุงุณุฎ ุตูุช ุจุฑุงุช ูุฑุณุชุงุฏู ๐ง")

# ----------------------------------------
# ุฑุงูโุงูุฏุงุฒ ุงูพูฺฉุดู
# ----------------------------------------
application = Application.builder().token(TOKEN).build()
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
application.add_handler(CallbackQueryHandler(button_handler))

# ----------------------------------------
# ุงุฌุฑุง Webhook ุฑู Render
# ----------------------------------------
if __name__ == "__main__":
    hostname = os.environ.get("RENDER_EXTERNAL_HOSTNAME")
    if not hostname:
        raise ValueError("โ ูุชุบุฑ RENDER_EXTERNAL_HOSTNAME ูพุฏุง ูุดุฏ!")
    url = f"https://{hostname}/{TOKEN}"
    print(f"โ Webhook ุฌุฏุฏ ุชูุธู ุดุฏ: {url}")

    application.run_webhook(
        listen="0.0.0.0",
        port=int(os.environ.get("PORT", 10000)),
        url_path=TOKEN,
        webhook_url=url
    )
