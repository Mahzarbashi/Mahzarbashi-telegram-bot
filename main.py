import os
import tempfile
from telegram import Bot, Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, MessageHandler, filters, CallbackQueryHandler, ContextTypes
from gtts import gTTS

# -----------------------------
# ุชูฺฉู ุชูฺฏุฑุงู
# -----------------------------
TOKEN = os.environ.get("TELEGRAM_TOKEN")
if not TOKEN:
    print("โ๏ธ ูุชุบุฑ ูุญุท TELEGRAM_TOKEN ูพุฏุง ูุดุฏ! ุงุฒ ุชูฺฉู ูููุช ุงุณุชูุงุฏู ูโุดูุฏ.")
    TOKEN = "8249435097:AAGOIS7GfwBayCTSZGFahbMhYcZDFxzSGAg"

bot = Bot(token=TOKEN)

# -----------------------------
# ูพุงู ุฎูุดโุขูุฏ ู ูุนุฑู
# -----------------------------
INTRO_TEXT = (
    "๐ ุณูุงู! ูู ุฏุณุชุงุฑ ุญููู ูุญุถุฑุจุงุด ูุณุชู.\n"
    "ุงู ุฑุจุงุช ุชูุณุท ูุณุชุฑู ุจูโุทุจุง ุณุงุฎุชู ุดุฏู ุงุณุช โ๏ธ\n"
    "ูู ูโุชููู ุจู ุณุคุงูุงุช ุญููู ุดูุง ูพุงุณุฎ ุจุฏู โ ูู ูุชู ู ูู ุตูุช ๐ง\n"
    "ฺฉุงูู ุณุคุงู ุญูููโุงุช ุฑู ุจูุฑุณุช ุชุง ุฑุงูููุงุช ฺฉูู."
)

# -----------------------------
# ูพุงุณุฎโูุง ุญููู
# -----------------------------
def legal_answer(text):
    text = text.strip().lower()

    if any(word in text for word in ["ุงุฒุฏูุงุฌ", "ูฺฉุงุญ"]):
        return (
            "๐ ุงุฒุฏูุงุฌ ฺฉ ุงุฒ ุนููุฏ ููู ุฏุฑ ูุงููู ูุฏู ุงุฑุงู ุงุณุช. "
            "ุจุฑุง ุตุญุช ุงุฒุฏูุงุฌุ ุจุงุฏ ุฑุถุงุช ฺฉุงูู ุฒู ู ูุฑุฏ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ ู "
            "ุนูุฏ ุชูุณุท ุฏู ุดุงูุฏ ูุฑุฏ ุงุฌุฑุง ุดูุฏ. "
            "ุงฺฏุฑ ฺฉ ุงุฒ ุทุฑูู ุงููุช ูุงููู ูุฏุงุดุชู ุจุงุดุฏุ ุนูุฏ ุจุงุทู ุงุณุช. "
            "ุฏุฑ ูฺฉุงุญ ุฏุงุฆูุ ุซุจุช ุงุฒุฏูุงุฌ ุงูุฒุงู ุงุณุช ู ููุฑู ูุฒ ุฌุฒู ุญููู ุฒู ูุญุณูุจ ูโุดูุฏ. "
            "ุฏุฑ ููุงุฑุฏ ุฎุงุต ูุซู ุงุฒุฏูุงุฌ ูุฌุฏุฏ ุง ุงุฒุฏูุงุฌ ุจุง ุงุชุจุงุน ุฎุงุฑุฌุ ูุงุฒ ุจู ุงุฌุงุฒู ุฑุณู ูุฌูุฏ ุฏุงุฑุฏ."
        )

    elif "ููุฑู" in text:
        return (
            "๐ฐ ููุฑู ูุงู ุงุณุช ฺฉู ููฺฏุงู ุนูุฏ ูฺฉุงุญุ ุจูโุนููุงู ุญู ุฒู ุชุนู ูโุดูุฏ. "
            "ุฒู ุจู ูุญุถ ุฌุงุฑ ุดุฏู ุนูุฏ ูุงูฺฉ ููุฑู ุงุณุช ู ูโุชูุงูุฏ ูุฑ ุฒูุงู ุจุฎูุงูุฏ ุขู ุฑุง ูุทุงูุจู ฺฉูุฏ. "
            "ุฏุฑ ุตูุฑุช ุงูุชูุงุน ุดููุฑุ ุฒู ูโุชูุงูุฏ ุงุฒ ุทุฑู ุฏุงุฏฺฏุงู ุฏุฑุฎูุงุณุช ุตุฏูุฑ ุงุฌุฑุงู ฺฉูุฏ. "
            "ุงฺฏุฑ ููุฑู ุนูุฏุงููุทุงูุจู ุจุงุดุฏุ ุจุงุฏ ุจูุงูุงุตูู ูพุฑุฏุงุฎุช ุดูุฏ. "
            "ุฏุฑ ููุฑู ุนูุฏุงูุงุณุชุทุงุนูุ ุฒู ุจุงุฏ ุชูุงูุง ูุงู ุดููุฑ ุฑุง ุงุซุจุงุช ฺฉูุฏ. "
            "ุชูุตู ูโุดูุฏ ููุดู ููุฑู ุจูโุตูุฑุช ุนุฏุฏ ู ุฑูุดู ุฏุฑ ุนูุฏูุงูู ุฐฺฉุฑ ุดูุฏ."
        )

    elif "ุทูุงู" in text:
        return (
            "๐ ุทูุงู ุฏุฑ ูุงููู ุงุฑุงู ุจู ุฏู ููุน ุชูุงูู ู ุบุฑุชูุงูู ุชูุณู ูโุดูุฏ. "
            "ุฏุฑ ุทูุงู ุชูุงููุ ุฒู ู ุดููุฑ ุจุง ุฑุถุงุช ูุชูุงุจู ุฌุฏุง ูโุดููุฏ ู ูุฑุงุญู ุฏุงุฏฺฏุงู ฺฉูุชุงูโุชุฑ ุงุณุช. "
            "ุฏุฑ ุทูุงู ุบุฑุชูุงููุ ฺฉ ุงุฒ ุทุฑูู ุจุงุฏ ุฏูุงู ููุฌู ุงุฑุงุฆู ุฏูุฏุ ูุซู ุนุณุฑ ู ุญุฑุฌ ุง ุนุฏู ูพุฑุฏุงุฎุช ูููู. "
            "ุฏุฑ ูุฑ ููุน ุทูุงูุ ุซุจุช ุฑุณู ู ุตุฏูุฑ ฺฏูุงู ุนุฏู ุงูฺฉุงู ุณุงุฒุด ุงูุฒุงู ุงุณุช. "
            "ูพุณ ุงุฒ ุทูุงูุ ุญููู ูุงู ุฒู ูุงููุฏ ููุฑู ู ูููู ุจุงุฏ ุชุณูู ุดูุฏ."
        )

    elif "ูููู" in text:
        return (
            "๐ ูููู ุนู ุชุฃูู ูุงุฒูุง ูุงู ู ูุนุดุช ุฒู ุชูุณุท ุดููุฑ. "
            "ุดุงูู ุฎูุฑุงฺฉุ ูพูุดุงฺฉุ ูุณฺฉู ู ูุฒููโูุง ุฏุฑูุงู ุงุณุช. "
            "ุงฺฏุฑ ุดููุฑ ุงุฒ ูพุฑุฏุงุฎุช ูููู ุฎูุฏุฏุงุฑ ฺฉูุฏุ ุฒู ูโุชูุงูุฏ ุงุฒ ุฏุงุฏฺฏุงู ุดฺฉุงุช ฺฉูุฏ. "
            "ุนุฏู ูพุฑุฏุงุฎุช ูููู ุฌุฑู ูุญุณูุจ ูโุดูุฏ ู ูุฌุงุฒุงุช ุญุจุณ ุฏุงุฑุฏ. "
            "ุฏุฑ ุนูุฏ ุฏุงุฆูุ ูููู ููุดู ุจุฑ ุนูุฏู ุดููุฑ ุงุณุชุ ูู ุฏุฑ ุนูุฏ ูููุช ููุท ุฏุฑ ุตูุฑุช ุดุฑุทุ ุงูุฒุงู ุฏุงุฑุฏ."
        )

    elif "ูุฑุงุฑุฏุงุฏ" in text or "ุนูุฏ" in text:
        return (
            "๐ ูุฑ ูุฑุงุฑุฏุงุฏ ุจุฑุง ุงุนุชุจุงุฑ ุจุงุฏ ุณู ุดุฑุท ุงุตู ุฏุงุดุชู ุจุงุดุฏ: "
            "ูุตุฏ ู ุฑุถุง ุทุฑููุ ุงููุช ูุงูููุ ู ููุถูุน ูุดุฑูุน. "
            "ุฏุฑ ุตูุฑุช ููุฏุงู ูุฑ ฺฉ ุงุฒ ุงู ููุงุฑุฏุ ูุฑุงุฑุฏุงุฏ ุจุงุทู ุงุณุช. "
            "ุจูุชุฑ ุงุณุช ุชูุงู ุดุฑูุท ู ุฌุฒุฆุงุช ูุฑุงุฑุฏุงุฏ ุจูโุตูุฑุช ฺฉุชุจ ุฐฺฉุฑ ุดูุฏ ุชุง ุงุฎุชูุงู ุงุฌุงุฏ ูุดูุฏ. "
            "ุฏุฑ ูุฑุงุฑุฏุงุฏูุง ููู ูุซู ุงุฌุงุฑูุ ุฎุฑุฏ ู ูุฑูุดุ ุง ุดุฑุงฺฉุชุ ุชูุธู ุฑุณู ุฏุฑ ุฏูุชุฑุฎุงูู ุชูุตู ูโุดูุฏ."
        )

    elif "ุงุฑุซ" in text or "ูุฑุงุซ" in text:
        return (
            "โฐ๏ธ ุงุฑุซ ุจู ุงููุงู ฺฏูุชู ูโุดูุฏ ฺฉู ูพุณ ุงุฒ ููุช ุดุฎุต ุจู ูุฑุงุซ ููุชูู ูโุดูุฏ. "
            "ูุงูููุ ูุฑุงุซ ุฑุง ุจู ุทุจูุงุช ูุฎุชูู ุชูุณู ฺฉุฑุฏู ุงุณุชุ ูพุฏุฑุ ูุงุฏุฑุ ูุฑุฒูุฏุ ููุณุฑ ู... "
            "ุณูู ูุฑ ูุงุฑุซ ุทุจู ูุงููู ูุดุฎุต ุงุณุช ู ุฒู ุฏุฑ ุตูุฑุช ุฏุงุดุชู ูุฑุฒูุฏุ ฺฉโูุดุชู ุงุฒ ุงููุงู ููููู ุฑุง ุงุฑุซ ูโุจุฑุฏ. "
            "ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงุฎุชูุงูุ ุจูุชุฑ ุงุณุช ุชูุณู ุงุฑุซ ุจุง ฺฏูุงู ุงูุญุตุงุฑ ูุฑุงุซุช ุงูุฌุงู ุดูุฏ."
        )

    elif "ุดฺฉุงุช" in text or "ุฏุงุฏฺฏุงู" in text or "ฺฉูุฑ" in text:
        return (
            "โ๏ธ ุจุฑุง ุซุจุช ุดฺฉุงุชุ ุงุจุชุฏุง ุจุงุฏ ููุน ุฌุฑู ุง ุฏุนูุง ูุดุฎุต ุดูุฏ. "
            "ุฏุฑ ุดฺฉุงุช ฺฉูุฑ ูุซู ุณุฑูุช ุง ุชูุฏุฏุ ุจุงุฏ ุฏุฑ ุฏุงุฏุณุฑุง ุทุฑุญ ุดูุฏ. "
            "ุฏุฑ ุฏุนุงู ุญููู ูุซู ูุทุงูุจู ููุฑู ุง ุงุฌุงุฑูโูุงููุ ุจุงุฏ ุฏุงุฏุฎูุงุณุช ุฏุฑ ุฏูุงุชุฑ ุฎุฏูุงุช ูุถุง ุซุจุช ฺฏุฑุฏุฏ. "
            "ููุฑุงู ุฏุงุดุชู ูุฏุงุฑฺฉุ ฺฉุงุฑุช ููุ ู ูุณุชูุฏุงุช ุงูุฒุงู ุงุณุช. "
            "ุฑุณุฏฺฏ ููฺฉู ุงุณุช ฺูุฏ ูุฑุญูู (ุจุฏูุ ุชุฌุฏุฏูุธุฑุ ุฏูุงู ุนุงู) ุฏุงุดุชู ุจุงุดุฏ."
        )

    else:
        return (
            "๐ ุงู ููุถูุน ุชุฎุตุตโุชุฑ ุงุณุช ู ูุงุฒ ุจู ุจุฑุฑุณ ุฏูู ุฏุงุฑุฏ. "
            "ูพุดููุงุฏ ูโฺฉูู ุจุฑุง ุฏุฑุงูุช ูพุงุณุฎ ฺฉุงููโุชุฑุ ูุงุฑุฏ ุณุงุช ูุญุถุฑุจุงุด ุดูุฏ:\n"
            "๐ www.mahzarbashi.ir"
        )

# -----------------------------
# ูุฏุฑุช ูพุงูโูุง ูุชู
# -----------------------------
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_text = update.message.text.strip()
    answer_text = legal_answer(user_text)

    reply_text = f"{answer_text}\n\n๐ ุจุฑุง ุดูุฏู ูพุงุณุฎุ ุฏฺฉูู ุฒุฑ ุฑุง ุจุฒูุฏ."
    keyboard = [[InlineKeyboardButton("๐ง ฺฏูุด ุฏุงุฏู ุตูุช", callback_data=f"voice:{answer_text}")]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(reply_text, reply_markup=reply_markup)

# -----------------------------
# ุชููุฏ ูพุงุณุฎ ุตูุช ุจุง gTTS
# -----------------------------
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data.startswith("voice:"):
        text = query.data.replace("voice:", "")
        tts = gTTS(text=text, lang='fa')
        with tempfile.NamedTemporaryFile(delete=False, suffix=".mp3") as tmp:
            tts.save(tmp.name)
            await bot.send_audio(chat_id=query.message.chat_id, audio=open(tmp.name, 'rb'))
        await query.edit_message_text("โ ูพุงุณุฎ ุตูุช ุงุฑุณุงู ุดุฏ ๐ง")

# -----------------------------
# ุฑุงูโุงูุฏุงุฒ ุฑุจุงุช
# -----------------------------
application = Application.builder().token(TOKEN).build()
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
application.add_handler(CallbackQueryHandler(button_handler))

# -----------------------------
# ุงุฌุฑุง Webhook ุฑู Render
# -----------------------------
if __name__ == "__main__":
    hostname = os.environ.get("RENDER_EXTERNAL_HOSTNAME")
    if not hostname:
        raise ValueError("โ ูุชุบุฑ ูุญุท RENDER_EXTERNAL_HOSTNAME ูพุฏุง ูุดุฏ!")
    url = f"https://{hostname}/{TOKEN}"
    print(f"โ Webhook set to: {url}")

    application.run_webhook(
        listen="0.0.0.0",
        port=int(os.environ.get("PORT", 10000)),
        url_path=TOKEN,
        webhook_url=url
    )
